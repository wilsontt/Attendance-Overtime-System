# 出勤加班單系統 Frontend

> **版本**：v1.2.0  
> **最後更新**：2025-12-09

本專案為一個 React + TypeScript 應用程式，旨在幫助使用者上傳出勤記錄（支援 CSV 與 TXT 格式），自動計算加班時數與誤餐費，並提供篩選、預覽、驗證與報表匯出（Excel/PDF/列印）等完整功能。

## 專案設定

1.  進入 `frontend/` 目錄：
    ```bash
    cd frontend
    ```
2.  安裝依賴套件：
    ```bash
    npm install
    ```

## 啟動開發伺服器

```bash
npm run dev
```
應用程式將在瀏覽器中啟動，通常位於 `http://localhost:5173`。

## 執行測試

```bash
npm test
```

## 技術棧

- **核心框架**：React 19 + TypeScript 5.0
- **建置工具**：Vite 6.0
- **資料解析**：
  - `react-papaparse`（CSV 解析）
  - 自訂 `txtParser.ts`（TXT 解析）
- **報表生成**：
  - `exceljs`（Excel 產生）
  - `html2canvas` + `jspdf`（PDF 產生）
- **測試框架**：Vitest + React Testing Library

## 主要功能

### 1. 檔案上傳與解析
- **支援格式**：CSV 與 TXT 兩種格式
- **智慧驗證**：自動檢查檔案格式、標題行、記錄數量
- **錯誤提示**：格式錯誤時提供明確的錯誤訊息

#### CSV 格式要求
```csv
員工編號,姓名,歸屬日期,考勤別,數量,上班時間,下班時間
200038,王小明,1141001,空,0,08:50,20:00
200039,李小華,1141002,病假,1,09:00,18:30
```

#### TXT 格式要求
- 必須包含標題行（員工姓名、歸屬日期）
- 固定寬度格式的刷卡記錄
- 至少 1 筆有效記錄

### 2. 加班與誤餐費計算

#### 時間對齊機制
- **開始時間**：向上對齊至整點（例：08:56 → 09:00）
- **結束時間**：向下對齊至 30 分鐘單位（例：19:45 → 19:30，17:04 → 17:00）
- **計算結果**：**< 30 分鐘不計算**，≥ 30 分鐘則向下對齊至 0.5 小時單位（例：18:00-18:25 → 0 小時，18:00-18:45 → 0.5 小時）

#### 計算規則
- **平日（週一至週五）**：
  - 加班從 18:00 開始計算至對齊後的下班時間
  - **< 30 分鐘不計算**，≥ 30 分鐘則向下對齊至 0.5 小時單位
  - 下班時間 ≥ 19:30 提供 $50 誤餐費
- **假日（週六、週日、國定假日）**：
  - 全天工時皆視為加班（對齊後的上班至下班時間）
  - **< 30 分鐘不計算**，≥ 30 分鐘則向下對齊至 0.5 小時單位
  - 不提供誤餐費

#### 範例
| 原始時間 | 顯示時間 | 對齊後計算時間 | 加班時數 | 誤餐費 | 說明 |
|---------|---------|--------------|---------|-------|------|
| 18:00 - 19:45 | 18:00 - 19:45 | 18:00 - 19:30 | 1.5 | $50 | 平日加班（≥ 30 分鐘） |
| 18:00 - 18:25 | 18:00 - 18:25 | 18:00 - 18:00 | 0 | $0 | 平日加班（< 30 分鐘不計算） |
| 18:00 - 18:45 | 18:00 - 18:45 | 18:00 - 18:30 | 0.5 | $0 | 平日加班（30 分鐘） |
| 08:56 - 17:04 | 08:56 - 17:04 | 09:00 - 17:00 | 8.0 | $0 | 假日全時段 |

### 3. 資料篩選
- **按姓名篩選**：輸入員工姓名，即時篩選結果
- **按日期篩選**：選擇開始與結束日期，顯示該範圍內的記錄

### 4. 預覽與驗證（v1.1.0 新增）
點擊「下載」按鈕後開啟預覽視窗：
- **記錄選擇**：勾選要包含在報表中的記錄
- **國定假日標記**：手動標記國定假日（影響計算規則）
- **工作地點填寫**：輸入工作地點資訊
- **加班原因編輯**：填寫每筆記錄的加班原因
- **自動分類**：自動分為「平日加班」與「例假日加班」兩個表格
- **頁碼顯示**：每個表格區塊顯示頁碼
- **必填驗證**：下載前檢查加班原因是否填寫（請假日除外）

### 5. 報表匯出
- **Excel 下載**：產生 `.xlsx` 檔（包含平日與例假日兩個工作表）
- **PDF 下載**：產生 `.pdf` 檔（包含頁碼、完整格式、支援中文）
- **列印功能**：開啟瀏覽器列印視窗（優化列印樣式）

## 專案結構

```
frontend/
├── src/
│   ├── components/        # React 元件
│   │   ├── FileUploader.tsx          # 檔案上傳組件（CSV/TXT）
│   │   ├── AttendanceTable.tsx       # 出勤表格顯示
│   │   ├── PreviewModal.tsx          # 預覽與驗證 Modal
│   │   └── PreviewModal.css          # Modal 樣式
│   ├── services/          # 核心服務
│   │   ├── txtParser.ts              # TXT 檔案解析服務
│   │   ├── calculationService.ts     # 加班時數計算服務（含時間對齊）
│   │   └── reportService.ts          # 報表生成服務（Excel/PDF/列印）
│   ├── pages/             # 頁面組件
│   │   └── HomePage.tsx              # 首頁（整合所有功能）
│   ├── types/             # TypeScript 型別定義
│   │   └── index.ts                  # 介面定義（AttendanceRecord, OvertimeReport）
│   ├── App.tsx            # 主應用組件
│   ├── main.tsx           # 應用程式進入點
│   └── index.css          # 全域樣式
├── tests/                 # 測試檔案
│   ├── components/                   # 組件測試
│   └── services/                     # 服務測試
├── public/                # 靜態資源
├── package.json           # 專案依賴與腳本
└── vite.config.ts         # Vite 設定檔
```

## 程式碼規範

- **命名規則**：
  - 變數/函數：`camelCase`
  - 介面/型別：`PascalCase`
  - 常數：`CONSTANT_CASE`
- **註解規範**：使用 JSDoc/TypeDoc 格式
- **型別安全**：嚴禁使用 `any`，所有參數與回傳值都有明確型別
- **非同步處理**：使用 `async/await`，不使用 `then/catch`

## 測試指令

```bash
# 執行所有測試
npm test

# 執行測試並顯示覆蓋率
npm run test:coverage

# 監聽模式（自動重新執行測試）
npm run test:watch
```

## 版本歷史

### v1.2.0 (2025-12-09)
**功能調整**：
- 🔧 調整加班時數計算規則：< 30 分鐘不計算，≥ 30 分鐘則向下對齊至 0.5 小時單位
- 🔧 調整「加班時間」顯示邏輯：顯示原始打卡時間，不顯示對齊後的時間

**改進項目**：
- 🔧 計算邏輯更符合實際需求（< 30 分鐘不計算）
- 🔧 顯示內容更直觀（顯示實際打卡時間）
- 📚 更新文件註解與說明

**技術改進**：
- 🚀 優化 `calculationService.ts`（新增 < 30 分鐘檢查邏輯）
- 🚀 調整 `overtimeRange` 計算邏輯（使用原始打卡時間）
- 🚀 新增測試案例驗證新規則

### v1.1.0 (2025-12-08)
**新增功能**：
- ✨ 支援 TXT 格式檔案上傳與解析
- ✨ 時間對齊機制（開始時間整點對齊、結束時間 30 分鐘對齊、時數 0.5 小時對齊）
- ✨ 預覽頁、PDF 與列印功能加入頁碼顯示
- ✨ 加班原因必填驗證
- ✨ 國定假日標記功能
- ✨ 記錄選擇功能

**改進項目**：
- 🔧 智慧格式驗證（檔案內容、標題行、記錄數量）
- 🔧 錯誤訊息更具體
- 🔧 報表格式更規範
- 📚 程式碼註解完整化（JSDoc/TypeDoc）

### v1.0.0 (2025-12-07)
**初始版本**：
- ✨ CSV 檔案上傳與解析
- ✨ 加班時數與誤餐費自動計算
- ✨ 姓名與日期範圍篩選
- ✨ Excel、PDF 報表匯出與列印功能