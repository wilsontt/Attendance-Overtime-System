# 出勤加班單系統 - 變更記錄

**日期**：2025 年 12 月 9 日  
**版本**：v1.2.0  
**狀態**：已完成  
**分支**：`feature/adjust-overtime-calculation`

---

## 📋 目的

記錄本次加班時數計算規則調整與功能修正的詳細內容，包含需求分析、解決方案、修改檔案清單及測試方式，以便日後維護與追蹤。

---

## 🎯 問題清單與解決方案

### 問題 1：調整加班時數計算規則（< 30 分鐘不計算）

#### 問題描述
根據需求文件，加班時數計算規則需要調整：
- **原規則**：所有加班時數向下對齊至 0.5 小時單位（即使 < 30 分鐘也會計算）
- **新規則**：加班時數 < 30 分鐘不計算，≥ 30 分鐘則向下對齊至 0.5 小時單位

#### 需求來源
參考 `出差記錄表-計算加班時間.md` 第 34-38 行：
- 加班時間 18:00 ～ 18:25，不到 30 分鐘不計算
- 加班時間 18:00 ～ 18:45，加班時間 45 分鐘，但不到 1 小時，算 30 分鐘（0.5 小時）
- 加班時間 18:00 ～ 19:15，加班時間 1 小時 15 分鐘，算 1 小時
- 加班時間 18:00 ～ 19:45，加班時間 1 小時 45 分鐘，算 1.5 小時
- 例假日算法相同

#### 解決方案
修改 `roundToHalfHour` 函數，新增「< 30 分鐘不計算」的邏輯：
1. 檢查時數是否 < 0.5 小時（30 分鐘）
2. 如果 < 0.5 小時，返回 0（不計算加班）
3. 如果 ≥ 0.5 小時，向下對齊至 0.5 小時單位

#### 修改檔案
- `frontend/src/services/calculationService.ts`

#### 實施細節

**修改 `roundToHalfHour` 函數**：

```typescript
/**
 * 將時數向下對齊到 0.5 小時單位
 * 規則：加班時數 < 30 分鐘不計算，≥ 30 分鐘則向下對齊至 0.5 小時單位
 * @param {number} hours - 原始時數
 * @returns {number} 對齊後的時數（< 0.5 小時返回 0）
 * @example
 * - 0.25 小時（15分鐘）→ 0 小時
 * - 0.5 小時（30分鐘）→ 0.5 小時
 * - 0.75 小時（45分鐘）→ 0.5 小時
 * - 1.25 小時（1小時15分鐘）→ 1.0 小時
 * - 1.75 小時（1小時45分鐘）→ 1.5 小時
 */
const roundToHalfHour = (hours: number): number => {
  // 如果時數小於 0.5 小時（30分鐘），不計算加班
  if (hours < 0.5) {
    return 0;
  }
  // 將時數轉換為 30 分鐘單位並向下對齊
  const halfHourUnits = Math.floor(hours / 0.5);
  return halfHourUnits * 0.5;
};
```

**更新文件註解**：

```typescript
/**
 * 加班時數與誤餐費計算服務
 * 
 * 計算規則：
 * - 時數對齊規則：
 *   - 加班時數 < 30 分鐘：不計算（返回 0）
 *   - 加班時數 ≥ 30 分鐘：向下對齊至 0.5 小時單位
 */
```

#### 測試方式
1. **測試 < 30 分鐘不計算**：
   - 平日：18:00 ～ 18:25（25 分鐘）→ 應返回 0 小時
   - 平日：18:00 ～ 18:29（29 分鐘）→ 應返回 0 小時

2. **測試 ≥ 30 分鐘正確對齊**：
   - 平日：18:00 ～ 18:45（45 分鐘）→ 應返回 0.5 小時
   - 平日：18:00 ～ 19:15（1 小時 15 分鐘）→ 應返回 1.0 小時
   - 平日：18:00 ～ 19:45（1 小時 45 分鐘）→ 應返回 1.5 小時

3. **測試例假日適用相同規則**：
   - 例假日：08:56 ～ 09:20（對齊後 09:00 ～ 09:00 = 0 分鐘）→ 應返回 0 小時
   - 例假日：08:56 ～ 09:45（對齊後 09:00 ～ 09:30 = 30 分鐘）→ 應返回 0.5 小時

#### 測試結果
✅ 所有 8 個測試案例通過（包含新增的 3 個測試案例）

---

### 問題 2：調整「加班時間」顯示邏輯（顯示原始打卡時間）

#### 問題描述
「加班時間」欄位目前顯示的是對齊後的時間，但需求要求顯示原始打卡時間：
- **原邏輯**：顯示對齊後的時間（例如：09:00 - 17:00）
- **新邏輯**：顯示原始打卡時間（例如：08:56 - 17:04）

#### 需求來源
使用者明確要求「加班時間」的顯示內容維持原來的方式：
- 平日：18:00 ～ 原始下班打卡時間
- 例假日：原始上班打卡時間 ～ 原始下班打卡時間

#### 解決方案
修改 `calculateOvertimeAndMealAllowance` 和 `recalculateOvertimeReport` 函數中的 `overtimeRange` 計算邏輯：
1. **例假日/週末/國定假日**：直接使用原始的 `clockIn` 和 `clockOut` 字串
2. **平日**：使用 `18:00` 和原始的 `clockOut` 字串
3. 移除對齊時間的計算，直接使用原始打卡時間

#### 修改檔案
- `frontend/src/services/calculationService.ts`

#### 實施細節

**修改 `calculateOvertimeAndMealAllowance` 函數**：

```typescript
// Calculate overtime range（顯示原始打卡時間，不顯示對齊後的時間）
let overtimeRange = '';
const dayOfWeek = getDayOfWeek(record.date);
if (overtimeHours > 0 && dayOfWeek !== null) {
  // 例假日/週末/國定假日：顯示原始上班打卡時間 ~ 原始下班打卡時間
  if (dayOfWeek === 0 || dayOfWeek === 6 || isHoliday) {
    overtimeRange = `${record.clockIn} - ${record.clockOut}`;
  } 
  // 平日：顯示 18:00 ~ 原始下班打卡時間
  else if (dayOfWeek >= 1 && dayOfWeek <= 5) {
    overtimeRange = `18:00 - ${record.clockOut}`;
  }
}
```

**修改 `recalculateOvertimeReport` 函數**：

```typescript
// Recalculate overtime range（顯示原始打卡時間，不顯示對齊後的時間）
let overtimeRange = '';
const dayOfWeek = getDayOfWeek(record.date);
if (overtimeHours > 0 && dayOfWeek !== null) {
  // 例假日/週末/國定假日：顯示原始上班打卡時間 ~ 原始下班打卡時間
  if (dayOfWeek === 0 || dayOfWeek === 6 || isHoliday) {
    overtimeRange = `${record.clockIn} - ${record.clockOut}`;
  } 
  // 平日：顯示 18:00 ~ 原始下班打卡時間
  else if (dayOfWeek >= 1 && dayOfWeek <= 5) {
    overtimeRange = `18:00 - ${record.clockOut}`;
  }
}
```

**移除未使用的函數**：
- 移除 `minutesToTime` 函數（不再需要將分鐘數轉換回時間字串）

#### 測試方式
1. **測試平日顯示**：
   - 輸入：09:00 ～ 19:45
   - 預期「加班時間」：`18:00 - 19:45`（顯示原始下班時間）
   - 預期「加班時數」：1.5 小時（使用對齊後的計算）

2. **測試例假日顯示**：
   - 輸入：08:56 ～ 17:04
   - 預期「加班時間」：`08:56 - 17:04`（顯示原始打卡時間）
   - 預期「加班時數」：8.0 小時（使用對齊後的計算：09:00 ～ 17:00）

3. **驗證計算與顯示分離**：
   - 「加班時數」使用對齊後的時間計算
   - 「加班時間」顯示原始打卡時間

#### 測試結果
✅ 所有 8 個測試案例通過

---

## 📝 修改檔案清單

### 核心服務
- `frontend/src/services/calculationService.ts`
  - 修改 `roundToHalfHour` 函數：新增 < 30 分鐘不計算的邏輯
  - 修改 `calculateOvertimeAndMealAllowance` 函數：調整 `overtimeRange` 顯示邏輯
  - 修改 `recalculateOvertimeReport` 函數：調整 `overtimeRange` 顯示邏輯
  - 移除 `minutesToTime` 函數（未使用）
  - 更新文件註解

### 測試檔案
- `frontend/tests/services/calculationService.test.ts`
  - 新增測試案例：驗證 < 30 分鐘不計算的規則
  - 新增測試案例：驗證 ≥ 30 分鐘正確對齊的規則
  - 新增測試案例：驗證例假日適用相同規則

---

## 🔍 影響範圍分析

### 功能影響
- ✅ **加班時數計算**：調整計算邏輯，< 30 分鐘不計算
- ✅ **加班時間顯示**：調整顯示邏輯，顯示原始打卡時間
- ✅ **誤餐費計算**：不受影響（仍以原始下班時間判斷）
- ✅ **例假日計算**：適用相同的 < 30 分鐘規則

### 向後相容性
- ⚠️ **計算結果變更**：原本 < 30 分鐘的加班時數會從 0.5 小時變為 0 小時
- ✅ **顯示格式不變**：仍為 `HH:mm - HH:mm` 格式
- ✅ **API 介面不變**：`OvertimeReport` 型別未變更

---

## ✅ 驗證清單

### 功能驗證
- [x] 加班時數 < 30 分鐘返回 0
- [x] 加班時數 ≥ 30 分鐘正確對齊
- [x] 平日與例假日計算邏輯一致
- [x] 「加班時間」顯示原始打卡時間
- [x] 「加班時數」使用對齊後的計算結果
- [x] 誤餐費計算不受影響

### 測試驗證
- [x] 單元測試：8 個測試案例全部通過
- [x] Lint 檢查：無錯誤
- [x] 程式碼審查：符合專案規範

---

## 📊 開發時程

| 時間 | 項目 |
|------|------|
| 2025-12-09 09:46 | 建立 Git 分支 `feature/adjust-overtime-calculation` |
| 2025-12-09 09:47 | 修改 `roundToHalfHour` 函數邏輯 |
| 2025-12-09 09:48 | 新增測試案例 |
| 2025-12-09 09:51 | 調整「加班時間」顯示邏輯 |
| 2025-12-09 09:52 | 移除未使用的函數 |
| 2025-12-09 09:52 | 完成所有測試與驗證 |

---

## ✅ 簽核

**開發完成**：✅ 2025-12-09  
**測試通過**：✅ 2025-12-09  
**文檔更新**：✅ 2025-12-09  
**程式碼審查**：✅ 2025-12-09

---

**變更記錄結束**

